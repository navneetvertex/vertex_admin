<div class="container-fluid">
    <app-page-title title="Assigned Cards" [breadcrumbItems]="breadCrumbItems"></app-page-title>

    <div  class="row">
        <div  class="col-lg-12">
            <div  class="card">
                <div class="card-body border-bottom">
                    <div class="row mb-0">
                        <div class="col-sm-4">
                            <div class="search-box me-2 mb-2 d-inline-block">
                                <div class="position-relative">
                                    <input
                                        type="text"
                                        autocomplete="off"
                                        id="searchTableList"
                                        placeholder="Search..."
                                        class="form-control"
                                        (keydown.enter)="search($event.target.value)"
                                    >
                                    <i class="bx bx-search-alt search-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div  class="card-body">
                    <div  class="row">
                            <div class="table-responsive">
                                <div class="d-flex flex-column justify-content-center align-items-center"  style="min-height: 150px;" *ngIf="ccList.length === 0" >
                                    <img src="assets/img/not-found.png" width="300px" alt="">
                                    <p class="text-mutes mt-2">No request found.</p>
                                </div> 
                                    <table id="basic-datatable" class="table table-bordered dt-responsive nowrap datatables no-footer dtr-inline"  *ngIf="ccList.length !== 0">
                                        <thead>
                                            <tr>
                                                <th>S.No.</th>
                                                <th>User Id</th>
                                                <th>Parent Id</th>
                                                <th>Indirect Id</th>
                                                <th>Card Limit</th>
                                                <th>Card Number</th>
                                                <th>Interest Rate</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <ng-container *ngFor="let cc of ccList; let i = index">
                                                <tr>
                                                    <td>{{ (page - 1) * pageSize + i + 1 }}</td>
                                                    <td>{{ cc?.user?.name }} <br> ({{cc?.user?.user_id}}) </td>
                                                    <td> <span *ngIf="cc?.direct_user">{{ cc?.direct_user?.name }} <br> ({{cc?.direct_user?.user_id}})</span>  </td>
                                                    <td> <span *ngIf="cc?.indirect_user">{{ cc?.indirect_user?.name }} <br> ({{cc?.indirect_user?.user_id}})</span>  </td>
                                                    <td>₹{{cc.approved_credit_limit}}</td>
                                                    <td>{{cc.card_number}}</td>
                                                    <td>{{cc.interest_rate}}%</td>
                                                    <td>
                                                        Requested On: {{cc.created_date | date}} <br>
                                                        Approved On: {{cc.approved_date ? (cc.approved_date | date) : 'N/A'}} <br>
                                                        Start Date: {{cc.start_date ? (cc.start_date | date) : 'N/A'}} <br>
                                                        Expiry Date: {{cc.expiry_date ? (cc.expiry_date | date) : 'N/A'}}
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{cc.status === 'Active' ? 'success' : cc.status === 'Requested' ? 'warning' : 'danger'}}">
                                                            {{cc.status}}
                                                        </span>
                                                        <br *ngIf="hasPenaltyRequest(cc)">
                                                        <span *ngIf="hasPenaltyRequest(cc)" 
                                                              class="badge bg-warning mt-1">
                                                            Penalty Request Pending
                                                        </span>
                                                    </td>
                                                    <td>

                                                        <ul class="list-inline font-size-20 contact-links mb-0" >
                                                            <li data-bs-toggle="modal" data-bs-target="#myModal" (click)="rejectCreditCardModal(RejectFormModal, cc)" class="list-inline-item px-2">
                                                                <a href="javascript:void(0);" tooltip="Reject Card">
                                                                <i class="bx bx-x"></i>
                                                                </a>
                                                            </li>
                                                            <li class="list-inline-item px-2" (click)="increaseCCLimit(cardLimitModal, cc)" >
                                                                <a href="javascript:void(0);" tooltip="Increase Limit">
                                                                <i class="bx bx-up-arrow"></i>
                                                                </a>
                                                            </li>
                                                            <li class="list-inline-item px-2" (click)="showCreditLimitHistory(creditLimitHistoryModal, cc)" >
                                                                <a href="javascript:void(0);" tooltip="Limit History">
                                                                <i class="bx bx-history"></i>
                                                                </a>
                                                            </li>
                                                            <ng-container *ngIf="hasPenaltyRequest(cc)">
                                                                <li class="list-inline-item px-2" (click)="approvePenaltyRequest(approvePenaltyModal, cc)" >
                                                                    <a href="javascript:void(0);" tooltip="Approve Penalty Request">
                                                                    <i class="bx bx-check text-success"></i>
                                                                    </a>
                                                                </li>
                                                                <li class="list-inline-item px-2" (click)="rejectPenaltyRequest(rejectPenaltyModal, cc)" >
                                                                    <a href="javascript:void(0);" tooltip="Reject Penalty Request">
                                                                    <i class="bx bx-x text-danger"></i>
                                                                    </a>
                                                                </li>
                                                            </ng-container>
                                                        </ul>
                                                    </td>
                                                </tr>
                                            </ng-container>
                                            
                                            
                                        </tbody>
                                    </table>
                                    <div class="row justify-content-md-between align-items-md-center mt-2">
                                      <div class="col-sm-12 col-md-5">
                                        <div class="dataTables_info mb-2" id="tickets-table_info" role="status" aria-live="polite">Showing
                                          <b>{{ (page - 1) * pageSize + 1 }}</b> to
                                          {{ findPageShowing() }} of {{ total }}
                                          entries
                                        </div>
                                      </div>
                                      <div class="col-sm-12 col-md-5">
                                        <div class="text-md-right float-md-end pagination-rounded">
                                          <ngb-pagination [collectionSize]="total" [(page)]="page" [pageSize]="pageSize" (pageChange)="pageChange($event)">
                                          </ngb-pagination>
                                        </div>
                                      </div>
                                    </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #cardLimitModal role="document" let-modal>
  <div class="modal-header">
      <h5 class="modal-title" id="myModalLabel">Increase Sahyog Card Limit (Current Limit : {{this.cc_selected.approved_credit_limit}})</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
<form [formGroup]="increaseCCFormGroup" novalidate>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="approved_credit_limit" class="form-label">Increase Card Limit</label>
                    <input
                        type="number"
                        id="approved_credit_limit"
                        class="form-control"
                        formControlName="approved_credit_limit"
                        min="500"
                        required
                        [class.is-invalid]="increaseCCFormGroup.get('approved_credit_limit')?.invalid && (increaseCCFormGroup.get('approved_credit_limit')?.touched || increaseCCFormGroup.get('approved_credit_limit')?.dirty)"
                    />
                    <div class="invalid-feedback" *ngIf="increaseCCFormGroup.get('approved_credit_limit')?.errors?.['required']">
                        Card limit is required.
                    </div>
                    <div class="invalid-feedback" *ngIf="increaseCCFormGroup.get('approved_credit_limit')?.errors?.['min']">
                        Card limit must be at least 500.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal" (click)="modal.close('Close click')">Close</button>
        <button type="button" class="btn btn-primary waves-effect waves-light" [disabled]="!increaseCCFormGroup.valid" (click)="increaseCreditCardLimit()">Submit</button>
    </div>
</form>
</ng-template>

<ng-template #RejectFormModal role="document" let-modal>
  <div class="modal-header">
      <h5 class="modal-title" id="myModalLabel">Reject Credit Card</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <form  [formGroup]="rejectCCFormGroup" novalidate>
  <div class="modal-body">
      <div class="row" >
        <div class="col-md-12">
                <div class="mb-3">
                    <label for="rejected_credit_limit" class="form-label">Rejected Credit Limit</label>
                    <select
                        id="rejected_credit_limit"
                        class="form-select"
                        formControlName="status"
                        [class.is-invalid]="rejectCCFormGroup.get('status')?.invalid && (rejectCCFormGroup.get('status')?.touched || rejectCCFormGroup.get('status')?.dirty)"
                        required >
                        <option value="Rejected">Rejected</option>
                        <option value="Blocked">Blocked</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="reason" class="form-label">Reason for Rejection</label>
                    <textarea
                        id="reason"
                        class="form-control"
                        formControlName="reason"
                        rows="3"
                        [class.is-invalid]="rejectCCFormGroup.get('reason')?.invalid && (rejectCCFormGroup.get('reason')?.touched || rejectCCFormGroup.get('reason')?.dirty)"
                        required
                        minlength="10"
                    ></textarea>
                    <div class="invalid-feedback" *ngIf="rejectCCFormGroup.get('reason')?.errors?.['required']">
                        Reason is required.
                    </div>
                    <div class="invalid-feedback" *ngIf="rejectCCFormGroup.get('reason')?.errors?.['minlength']">
                        Reason must be at least 10 characters.
                    </div>
                </div>
                
        </div>
      </div>
    </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal" (click)="modal.close('Close click')">Close</button>
        <button type="button" class="btn btn-primary waves-effect waves-light" [disabled]="!rejectCCFormGroup.valid"  (click)="rejectCreditCard()" >Submit</button>
      </div>

    </form>
</ng-template>

<ng-template #approvePenaltyModal role="document" let-modal>
  <div class="modal-header">
      <h5 class="modal-title" id="approvePenaltyModalLabel">Approve Penalty Removal Request</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <form [formGroup]="penaltyActionFormGroup" novalidate>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="penalty_removed" class="form-label">Penalty Amount to Remove (₹)</label>
                    <input
                        type="number"
                        id="penalty_removed"
                        class="form-control"
                        formControlName="penalty_removed"
                        min="0"
                        step="0.01"
                        required
                        [class.is-invalid]="penaltyActionFormGroup.get('penalty_removed')?.invalid && (penaltyActionFormGroup.get('penalty_removed')?.touched || penaltyActionFormGroup.get('penalty_removed')?.dirty)"
                    />
                    <div class="invalid-feedback" *ngIf="penaltyActionFormGroup.get('penalty_removed')?.errors?.['required']">
                        Penalty amount is required.
                    </div>
                    <div class="invalid-feedback" *ngIf="penaltyActionFormGroup.get('penalty_removed')?.errors?.['min']">
                        Penalty amount must be 0 or greater.
                    </div>
                </div>
                <div class="mb-3" *ngIf="cc_selected">
                    <label class="form-label">Request Details</label>
                    <div class="border p-3 bg-light">
                        <p class="mb-1"><strong>User:</strong> {{ cc_selected?.user?.name }} ({{ cc_selected?.user?.user_id }})</p>
                        <p class="mb-1"><strong>Card:</strong> {{ cc_selected?.card_number }}</p>
                        <p class="mb-1"><strong>Current Penalty:</strong> ₹{{ cc_selected?.penalty || 0 }}</p>
                        <p class="mb-1" *ngIf="getPenaltyRequestForCard(cc_selected)"><strong>Reason:</strong> {{ getPenaltyRequestForCard(cc_selected)?.reason }}</p>
                        <p class="mb-1" *ngIf="getPenaltyRequestForCard(cc_selected)"><strong>Requested On:</strong> {{ getPenaltyRequestForCard(cc_selected)?.request_date | date }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal" (click)="modal.close('Close click')">Cancel</button>
        <button type="button" class="btn btn-success waves-effect waves-light" [disabled]="!penaltyActionFormGroup.get('penalty_removed')?.valid" (click)="approvePenaltyRemovalRequest()">Approve Request</button>
    </div>
  </form>
</ng-template>

<ng-template #rejectPenaltyModal role="document" let-modal>
  <div class="modal-header">
      <h5 class="modal-title" id="rejectPenaltyModalLabel">Reject Penalty Removal Request</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <form [formGroup]="penaltyActionFormGroup" novalidate>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="admin_response" class="form-label">Reason for Rejection</label>
                    <textarea
                        id="admin_response"
                        class="form-control"
                        formControlName="admin_response"
                        rows="3"
                        required
                        minlength="10"
                        [class.is-invalid]="penaltyActionFormGroup.get('admin_response')?.invalid && (penaltyActionFormGroup.get('admin_response')?.touched || penaltyActionFormGroup.get('admin_response')?.dirty)"
                    ></textarea>
                    <div class="invalid-feedback" *ngIf="penaltyActionFormGroup.get('admin_response')?.errors?.['required']">
                        Reason for rejection is required.
                    </div>
                    <div class="invalid-feedback" *ngIf="penaltyActionFormGroup.get('admin_response')?.errors?.['minlength']">
                        Reason must be at least 10 characters.
                    </div>
                </div>
                <div class="mb-3" *ngIf="cc_selected">
                    <label class="form-label">Request Details</label>
                    <div class="border p-3 bg-light">
                        <p class="mb-1"><strong>User:</strong> {{ cc_selected?.user?.name }} ({{ cc_selected?.user?.user_id }})</p>
                        <p class="mb-1"><strong>Card:</strong> {{ cc_selected?.card_number }}</p>
                        <p class="mb-1"><strong>Current Penalty:</strong> ₹{{ cc_selected?.penalty || 0 }}</p>
                        <p class="mb-1" *ngIf="getPenaltyRequestForCard(cc_selected)"><strong>Reason:</strong> {{ getPenaltyRequestForCard(cc_selected)?.reason }}</p>
                        <p class="mb-1" *ngIf="getPenaltyRequestForCard(cc_selected)"><strong>Requested On:</strong> {{ getPenaltyRequestForCard(cc_selected)?.request_date | date }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal" (click)="modal.close('Close click')">Cancel</button>
        <button type="button" class="btn btn-danger waves-effect waves-light" [disabled]="!penaltyActionFormGroup.get('admin_response')?.valid" (click)="rejectPenaltyRemovalRequest()">Reject Request</button>
    </div>
  </form>
</ng-template>

<ng-template #creditLimitHistoryModal role="document" let-modal>
  <div class="modal-header">
      <h5 class="modal-title" id="creditLimitHistoryModalLabel">Credit Limit History</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
  </div>
  <div class="modal-body">
      <div class="row mb-3" *ngIf="cc_selected">
          <div class="col-md-12">
              <div class="card border">
                  <div class="card-body">
                      <h6 class="card-title">Card Details</h6>
                      <div class="row">
                          <div class="col-md-6">
                              <p class="mb-1"><strong>Card Number:</strong> {{ cc_selected?.card_number }}</p>
                              <p class="mb-1"><strong>User:</strong> {{ cc_selected?.user?.name }} ({{ cc_selected?.user?.user_id }})</p>
                          </div>
                          <div class="col-md-6">
                              <p class="mb-1"><strong>Current Limit:</strong> ₹{{ cc_selected?.approved_credit_limit }}</p>
                              <p class="mb-1"><strong>Status:</strong> {{ cc_selected?.status }}</p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <div class="row">
          <div class="col-md-12">
              <div *ngIf="limitHistoryLoading" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading limit history...</p>
              </div>

              <div *ngIf="!limitHistoryLoading && limitHistory.length === 0" class="text-center py-4">
                  <img src="assets/img/not-found.png" width="100px" alt="" class="mb-3">
                  <p class="text-muted">No limit history found for this card.</p>
              </div>

              <div *ngIf="!limitHistoryLoading && limitHistory.length > 0" class="timeline">
                  <div class="timeline-item" *ngFor="let history of limitHistory; let i = index">
                      <div class="timeline-marker">
                          <i [class]="getChangeTypeIcon(history.change_type)"></i>
                      </div>
                      <div class="timeline-content">
                          <div class="d-flex justify-content-between align-items-start">
                              <div>
                                  <h6 class="mb-1">
                                      <span class="badge" [class]="history.change_type === 'Increase' ? 'bg-success' : 'bg-danger'">
                                          {{ history.change_type }}
                                      </span>
                                      ₹{{ history.amount_changed | number }}
                                  </h6>
                                  <p class="mb-1 text-muted small">
                                      {{ history.created_date | date:'medium' }}
                                  </p>
                                  <p class="mb-1">
                                      <strong>Old Limit:</strong> ₹{{ history.old_limit | number }} →
                                      <strong>New Limit:</strong> ₹{{ history.new_limit | number }}
                                  </p>
                                  <p class="mb-1" *ngIf="history.reason">
                                      <strong>Reason:</strong> {{ history.reason }}
                                  </p>
                                  <p class="mb-1" *ngIf="history.reason_details">
                                      <strong>Details:</strong> {{ history.reason_details }}
                                  </p>
                                  <p class="mb-1" *ngIf="history.updated_by_details">
                                      <strong>Updated by:</strong> {{ history.updated_by_details.name }} ({{ history.updated_by_details.user_id }})
                                      <span class="badge bg-secondary ms-1">{{ history.updated_by_role }}</span>
                                  </p>
                                  <p class="mb-1" *ngIf="history.approval_required">
                                      <strong>Status:</strong>
                                      <span class="badge" [class]="history.status === 'Approved' ? 'bg-success' : history.status === 'Rejected' ? 'bg-danger' : 'bg-warning'">
                                          {{ history.status }}
                                      </span>
                                      <span *ngIf="history.approval_date"> on {{ history.approval_date | date:'medium' }}</span>
                                  </p>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
  <div class="modal-footer">
      <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal" (click)="modal.close('Close click')">Close</button>
  </div>
</ng-template>